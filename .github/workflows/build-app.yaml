name: Cross-Platform Release

on:
  push:
    tags:
      - 'v*'  # Trigger only on version tags like v1.0.0

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build Windows .exe
        run: |
          pyinstaller --onefile --name unitconverter main.py

      - name: Upload .exe to Release
        uses: softprops/action-gh-release@v1
        with:
          files: dist/unitconverter.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install py2app

      - name: Create setup.py
        run: |
          echo "from setuptools import setup" > setup.py
          echo "APP = ['main.py']" >> setup.py
          echo "OPTIONS = {'argv_emulation': True}" >> setup.py
          echo "setup(app=APP, options={'py2app': OPTIONS}, setup_requires=['py2app'])" >> setup.py

      - name: Build macOS .app
        run: python setup.py py2app

      - name: Zip .app bundle
        run: |
          cd dist
          zip -r unitconverter-mac.zip *.app

      - name: Upload .app to Release
        uses: softprops/action-gh-release@v1
        with:
          files: dist/unitconverter-mac.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y fuse libfuse2
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build binary
        run: |
          pyinstaller --onefile --name unitconverter main.py

      - name: Prepare AppDir
        run: |
          mkdir -p AppDir/usr/bin
          cp dist/unitconverter AppDir/usr/bin/
          chmod +x AppDir/usr/bin/unitconverter

          mkdir -p AppDir/usr/share/applications
          echo "[Desktop Entry]
          Type=Application
          Name=UnitConverter
          Exec=unitconverter
          Icon=unitconverter
          Categories=Utility;" > AppDir/usr/share/applications/unitconverter.desktop

          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
          # Optional: cp icon.png AppDir/usr/share/icons/hicolor/256x256/apps/unitconverter.png

      - name: Download appimagetool
        run: |
          wget https://github.com/AppImage/AppImageKit/releases/latest/download/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage

      - name: Build AppImage
        run: |
          ./appimagetool-x86_64.AppImage AppDir unitconverter-x86_64.AppImage

      - name: Upload AppImage to Release
        uses: softprops/action-gh-release@v1
        with:
          files: unitconverter-x86_64.AppImage
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
